<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <template id="report_pe_invoice_document">
        <t t-call="dv_customization_formats.external_layout_price_A4">
            <t t-set="doc" t-value="doc.with_context(lang=doc.partner_id.lang)"/>
            <div t-attf-class="{{'o_report_layout_background' if doc.company_id.layout_background in ['Geometric', 'Custom'] else ''}}"
                 t-attf-style="background-image: url({{ 'data:image/png;base64,%s' % doc.company_id.layout_background_image.decode('utf-8') if doc.company_id.layout_background_image and doc.company_id.layout_background == 'Custom' else '/base/static/img/bg_background_template.jpg' if doc.company_id.layout_background == 'Geometric' else ''}}); background-size: cover; background-position: center;"
                 t-att-data-oe-model="doc and doc._name"
                 t-att-data-oe-id="doc and doc.id"
                 style="position: relative;">

                <div>
                    <!-- Encabezado (Listo) -->
                    <div class="container" style="font-size: 12px; display: flex; align-items: center;">

                        <div class="row">

                            <div class="text-center" style="width: 23%; max-width: 23%; flex-shrink: 0;">
                                <img t-if="doc.company_id.logo" t-att-src="image_data_uri(doc.company_id.logo)" style="height:150px; width: 222px;"/>
                            </div>
                            <div style="width: 3%;"></div>

                            <div style="width: 43%; overflow-wrap: break-word; word-wrap: break-word; display: flex; align-items: start; padding: 25px 0px 0px 0px;">
                                <div>
                                    <div class="container">
                                        <div class="row">
                                            <div class="col">
                                                <div class="mb-3 p0" style="font-weight: bold; font-size: 17px;">
                                                    <t t-out="doc.company_id.name"/>
                                                </div>

                                                <div class="mb-3 p0" style="font-size: 13px; font-weight: normal; color: #222;">
                                                    <t t-out="doc.company_id.street"/>
                                                </div>

                                                <div>
                                                    <div style="margin:0px 0px 2px 0px; padding:0px; font-size: 13px; font-weight: normal; color: #222;">
                                                        <t t-out="doc.company_id.email"/>
                                                    </div>
                                                    <div style="margin:0px; padding:0px; font-size: 13px; color: #222;">
                                                        <t t-out="doc.company_id.website"/>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div style="width: 1%;"></div>

                            <div class="text-center" style="width: 30%; border: 2px solid black; padding: 20px 0px 0px 0px;">
                                <p style="font-size: 15px;">
                                    <strong>R.U.C. N° </strong>
                                    <strong><span t-esc="doc.company_id.vat"/></strong>
                                </p>
                                <p style="font-size: 18px;">
                                    <strong>FACTURA ELECTRÓNICA</strong>
                                </p>
                                <p style="font-size: 15px;">
                                    <strong>
                                        <t t-out="doc.name.replace(' ','')"/>
                                    </strong>
                                </p>
                            </div>

                        </div>

                        <div class="row" style="margin-top:8px;">
                            <div style="width: 6%; max-width: 8%;"></div>
                            <div style="width: 53%; max-width: 53%;">
                                <table style="width: 100%; border-collapse: collapse; border-color: white; font-size: 13px;">
                                    <tbody>
                                        <tr>
                                            <td width="25%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start;">
                                                <strong>RAZÓN SOCIAL:&#160;&#160;</strong>
                                            </td>
                                            <td width="75%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start; color: #222;">
                                                <t t-esc="doc.partner_id.name and doc.partner_id.name.upper() or ''"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td width="25%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start;">
                                                <strong>RUC:&#160;&#160;</strong>
                                            </td>
                                            <td width="75%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start; color: #222;">
                                                <t t-esc="doc.partner_id.vat or ''"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td width="25%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start;">
                                                <strong>DIRECCIÓN:&#160;&#160;</strong>
                                            </td>
                                            <td width="75%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start; color: #222;">
                                                <t t-esc="doc.partner_id.street and doc.partner_id.street.upper() or ''"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td width="25%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start;">
                                                <strong>EMISIÓN:&#160;&#160;</strong>
                                            </td>
                                            <td width="75%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start; color: #222;">
                                                <t t-esc="doc.invoice_date and doc.invoice_date.strftime('%d/%m/%Y') or ''"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td width="25%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start;">
                                                <strong>MONEDA:&#160;&#160;</strong>
                                            </td>
                                            <td width="75%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start; color: #222;">
                                                <t t-esc="doc.currency_id.name or ''"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div style="width: 41%; max-width: 39%;">
                                <table style="width: 100%; border-collapse: collapse; border-color: white; font-size: 13px;">
                                    <tbody>
                                        <tr>
                                            <td width="40%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start;">
                                                <strong>HORA:&#160;&#160;</strong>
                                            </td>
                                            <td width="60%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start; color: #222;">
                                                <t t-esc="doc.create_date and doc.create_date.strftime('%H:%M') or ''"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td width="40%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start;">
                                                <strong>FORMA DE PAGO:&#160;&#160;</strong>
                                            </td>
                                            <td width="60%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start; color: #222;">
                                                <t t-esc="doc.invoice_payment_term_id.name and doc.invoice_payment_term_id.name.upper() or ''"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td width="40%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start;">
                                                <strong>TIPO DE OPERACIÓN:&#160;&#160;</strong>
                                            </td>
                                            <td width="60%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start; color: #222;">
                                                <t t-esc="'FACTURA ELECTRÓNICA'"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td width="40%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start;">
                                                <strong>PLACA:&#160;&#160;</strong>
                                            </td>
                                            <td width="60%" style="margin:0px 0px 1px 0px; padding:0px; text-align:start; color: #222;">
                                                <t t-esc="doc.placa or ''"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                    </div>

                    <!-- Cuerpo -->
                    <div class="container" style="margin-top:6px;">

                        <t t-if="doc.invoice_line_ids.filtered(lambda l: l.product_id.detailed_type in ['consu', 'product'])">
                            <div class="row">
                                <table class="table table-borderless" style="font-size:13px; line-height: 1;">
                                    <thead>
                                        <tr style="background-color:#3D3D3D; color:white;">
                                            <th scope="col" style="width: 4%; text-align:center;">ITEM</th>
                                            <th scope="col" style="width: 12%; text-align:center;">CODIGO</th>
                                            <th scope="col" style="width: 10%; text-align:center;">CANTIDAD</th>
                                            <th scope="col" style="width: 53%; text-align:center;">DESCRIPCION DE PRODUCTO</th>
                                            <th scope="col" style="width: 7%; text-align:end;">PRECIO</th>
                                            <th scope="col" style="width: 7%; text-align:end;">DSC</th>
                                            <th scope="col" style="width: 7%; text-align:end;">IMPORTE</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-set="count" t-value="1"/>
                                        <t t-foreach="doc.invoice_line_ids.filtered(lambda l: l.product_id.detailed_type in ['consu', 'product'])" t-as="line">
                                            <tr>
                                                <td style="text-align:center;"><t t-esc="count"/></td>
                                                <td style="text-align:center;"><t t-esc="line.product_id.default_code.upper() if line.product_id.default_code else ''"/></td>
                                                <td style="text-align:center;"><t t-esc="line.quantity"/></td>
                                                <td style="text-align:start;"><t t-esc="line.product_id.name.upper()"/></td>
                                                <td style="text-align:end;"><t t-esc="line.price_unit"/></td>
                                                <td style="text-align:end;"><t t-esc="line.discount_custom if line.discount_custom else 0.00"/></td>
                                                <td style="text-align:end;"><t t-esc="line.price_total"/></td>
                                            </tr>
                                            <!-- Contador de la iteración -->
                                            <t t-set="count" t-value="count + 1"/>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </t>

                        <t t-if="doc.invoice_line_ids.filtered(lambda l: l.product_id.detailed_type in ['service'])">
                            <div class="row">
                                <table class="table table-borderless" style="font-size:13px; line-height: 1;">
                                    <thead>
                                        <tr style="background-color:#3D3D3D; color: white;">
                                            <th scope="col" style="width: 4%; text-align:center;">ITEM</th>
                                            <th scope="col" style="width: 12%; text-align:center;">CODIGO</th>
                                            <th scope="col" style="width: 10%; text-align:center;">CANTIDAD</th>
                                            <th scope="col" style="width: 53%; text-align:center;">DESCRIPCION DE SERVICIO</th>
                                            <th scope="col" style="width: 7%; text-align:end;">PRECIO</th>
                                            <th scope="col" style="width: 7%; text-align:end;">DSC</th>
                                            <th scope="col" style="width: 7%; text-align:end;">IMPORTE</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-set="count" t-value="1"/>
                                        <t t-foreach="doc.invoice_line_ids.filtered(lambda l: l.product_id.detailed_type == 'service')" t-as="line">
                                            <tr>
                                                <td style="text-align:center;"><t t-esc="count"/></td>
                                                <td style="text-align:center;"><t t-esc="line.product_id.default_code.upper() if line.product_id.default_code else ''"/></td>
                                                <td style="text-align:center;"><t t-esc="line.quantity"/></td>
                                                <td style="text-align:start;"><t t-esc="line.product_id.name.upper()"/></td>
                                                <td style="text-align:end;"><t t-esc="line.price_unit"/></td>
                                                <td style="text-align:end;"><t t-esc="line.discount_custom if line.discount_custom else 0.00"/></td>
                                                <td style="text-align:end;"><t t-esc="line.price_total"/></td>
                                            </tr>
                                            <!-- Contador de la iteración -->
                                            <t t-set="count" t-value="count + 1"/>
                                        </t>
                                    </tbody>
                                </table>
                            </div>
                        </t>


                        <!-- Calculos de valores total, subtotal y igv -->
                        <t t-set="sum_total_con_igv" t-value="0"/>
                        <t t-set="sum_total_sin_igv" t-value="0"/>
                        <t t-foreach="doc.invoice_line_ids" t-as="line">
                            <t t-set="sum_total_con_igv" t-value="sum_total_con_igv + line.price_total"/>
                            <t t-set="sum_total_sin_igv" t-value="sum_total_sin_igv + line.price_subtotal"/>
                        </t>

                        <!-- Subtotales - IGV - Total (AJUSTAR)-->
                        <div class="row justify-content-end" style="page-break-inside: avoid;">
                            <div class="col-3" style="border: 2px solid #3D3D3D; border-radius: 5px; padding: 10px; background-color: white; page-break-inside: avoid;">
                                <table class="table table-borderless" style="font-size:14px; margin-bottom: 0; page-break-inside: avoid;">
                                    <tbody>
                                        <tr>
                                            <td style="text-align: start;">Subtotal:</td>
                                            <td style="text-align: end;">
                                                <t t-esc="('%.2f' % (sum_total_sin_igv))"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: start;">IGV:</td>
                                            <td style="text-align: end;">
                                                <t t-esc="('%.2f' % (sum_total_con_igv - sum_total_sin_igv))"/>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="text-align: start; font-weight: bold;">Total:</td>
                                            <td style="text-align: end; font-weight: bold;">
                                                <t t-esc="('%.2f' % (sum_total_con_igv))"/>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>


                </div>
            </div>

        </t>
    </template>

    <template id="report_invoice" inherit_id="account.report_invoice">
        <xpath expr="//t[@t-call='web.html_container']" position="replace">

            <t t-call="web.html_container">
                <t t-foreach="docs" t-as="doc">
                    <t t-set="lang" t-value="doc.partner_id.lang"/>
                    <t t-if="doc._get_name_invoice_report() == 'dv_customization_formats.report_pe_invoice_document'"
                       t-call="dv_customization_formats.report_pe_invoice_document"
                       t-lang="lang"/>
                </t>
            </t>

        </xpath>
    </template>

    <record id="A4_price_format" model="report.paperformat">
        <field name="name">A4-invoice</field>
        <field name="default" eval="True" />
        <field name="format">A4</field>
        <field name="orientation">Portrait</field>
        <field name="margin_top">5.00</field>
        <field name="margin_bottom">30.00</field>
        <field name="margin_left">7.0</field>
        <field name="margin_right">7.0</field>
        <field name="header_line" eval="False" />
        <field name="header_spacing">20</field>
        <field name="dpi">90</field>
    </record>

</odoo>