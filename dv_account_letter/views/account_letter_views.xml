<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Filtros -->
    <record model="ir.ui.view" id="ccount_letter_view_filter">
        <field name="name">account_letter.view.filter</field>
        <field name="model">account.letter</field>
        <field name="arch" type="xml">
            <search string="Búsqueda de canje">
                <field name="partner_id" filter_domain="[
                    '|',('partner_id', 'ilike', self),('letter_line_ids', 'ilike', self)]"/>
                <field name="letter_line_ids" string="Letras"/>
                <field name="name"/>
                <field name="journal_id"/>
                <field name="state"/>
                <filter name="draft" string="Borrador" domain="[('state','=','draft')]"/>
                <filter name="checked" string="Comprobado" domain="[('state','=','checked')]"/>
                <filter name="redeemed" string="Canjeado" domain="[('state','=','redeemed')]"/>
                <filter name="billing" string="En cobranza" domain="[('state','=','billing')]"/>
                <filter name="done" string="Finalizado" domain="[('state','=','done')]"/>
                <filter name="cancel" string="Cancelado" domain="[('state','=','cancel')]"/>
                <group expand="0" string="Group By">
                    <filter name="group_partner" string="Socio" context="{'group_by':'partner_id'}"/>
                    <filter name="group_journal" string="Diario" context="{'group_by':'journal_id'}"/>
                    <filter name="group_state" string="Estado" context="{'group_by':'state'}"/>
                </group>
            </search>
        </field>
    </record>
    <!-- Vista Lista-->
    <record model="ir.ui.view" id="account_letter_tree">
      <field name="name">account_letter.view.tree</field>
      <field name="model">account.letter</field>
      <field name="arch" type="xml">
        <tree>
            <field name="name"/>
            <field name="partner_id" string="Socio"/>
            <field name="invoice_date"/>
            <field name="payment_reference"/>
            <field name="journal_id"/>
            <field name="state" widget="badge"
                    decoration-info="state == 'checked'"
                    decoration-warning="state in ('redeemed','billing')"
                    decoration-success="state == 'done'"
                    decoration-danger="state == 'cancel'"/>
            <field name="redeemed_type" widget="badge"
                    decoration-info="redeemed_type == 'origin'"
                    decoration-success="redeemed_type == 'renewal'"
                    decoration-warning="redeemed_type == 'protested'"/>
            <field name="invoice_line_ids" widget="many2many_tags" string="Facturas" optional="hide"/>
        </tree>
      </field>
    </record>
    <!-- Vista Formulario-->
    <record model="ir.ui.view" id="_account_letter_form">
        <field name="name">account_letter.view.form</field>
        <field name="model">account.letter</field>
        <field name="arch" type="xml">
            <form>
                <header>
                    <button name="action_checked" string="Confirmar" class="oe_highlight" type="object" 
                        invisible="state != 'draft' or state == 'cancel'"/>
                    <button name="action_redeemed" string="Canjear" class="oe_highlight" type="object" 
                        invisible="state != 'checked'"/>
                    <button name="%(dv_account_letter.account_letter_bank_action)d" string="En Banco" class="oe_highlight" type="action" 
                        invisible="state != 'redeemed'"/>
                    <button name="action_draft" string="Restablecer a borrador" type="object" 
                        invisible="state != 'checked'"/>
                    <button name="action_cancel" string="Cancelar" type="object" 
                        invisible="state not in ('draft','checked','redeemed')"/>
                    <button name="action_renewal" string="Renovar" type="object" 
                        invisible="not is_renewal or protested_parent_id or renewal_parent_id"/>
                    <button name="action_protest" string="Protesto" type="object" 
                        invisible="not is_protested"/>
                    <!-- <button name="action_change_protested" string="Protesto" type="object" 
                        invisible="not is_protested or redeemed_type != 'protested'"/> -->
                    <button name="action_protest" string="Refinanciar" type="object"
                        invisible="not is_refinanced or is_protested or protested_parent_id"/>
                    <field name="state" widget="statusbar" statusbar_visible="draft,checked,redeemed,billing,done"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_open_related_payments"
                            type="object"
                            class="oe_stat_button"
                            icon="fa-money"
                            invisible="count_payment == 0">
                            <field name="count_payment" widget="statinfo" string="Pagos"/>
                        </button>
                        <button name="action_open_related_debit_notes"
                            type="object"
                            class="oe_stat_button"
                            icon="fa-pencil-square"
                            invisible="count_debit_notes == 0">
                            <field name="count_debit_notes" widget="statinfo" string="Notas Debito"/>
                        </button>
                    </div>
                    <!-- Etiquetas ribbon -->
                    <widget name="web_ribbon" title="Renovado" invisible="renewal_parent_id == False and state != 'cancel'"/>
                    <widget name="web_ribbon" title="Refinanciado" bg_color="text-bg-warning" invisible="protested_parent_id == False and state != 'cancel'"/>
                    <widget name="web_ribbon" title="Cancelado" bg_color="text-bg-danger" invisible="state != 'cancel'"/>
                    <div class="oe_title">
                        <span class="o_form_label">Nro.Canje</span>
                        <h1>
                            <field name="name" placeholder="Draft"/>
                        </h1>
                    </div>
                    <group>
                        <group id="header_left_group">
                            <label for="partner_id" string="Cliente" style="font-weight:bold;"
                                    invisible="type == 'in_invoice'"/>
                            <label for="partner_id" string="Proveedor" style="font-weight:bold;"
                                    invisible="type == 'out_invoice'"/>
                            <field name="partner_id" nolabel="1" readonly="state != 'draft'"/>
                            <field name="journal_id" readonly="state != 'draft'"/>
                        </group>
                        <group id="header_right_group">
                            <label for="invoice_date" string="Fecha Canje" style="font-weight:bold;"/>
                            <field name="invoice_date" nolabel="1" readonly="state != 'draft'"/>
                            <field name="payment_reference" readonly="state != 'draft'"/>
                            <field name="currency_id" readonly="state != 'draft'"/>
                            <field name="move_id" readonly="1" invisible="state in ('draft','checked')"/>
                            <!-- Campos invisibles -->
                            <field name="type" invisible="1"/>
                            <field name="company_id" invisible="1"/>
                            <field name="is_renewal" invisible="1"/>
                            <field name="is_protested" invisible="1"/>
                            <field name="is_refinanced" invisible="1"/>
                            <field name="redeemed_type" invisible="1"/>
                        </group>
                        <group id="renewed">
                            <field name="renewal_ids" widget="many2many_tags" string="Renovaciones" invisible="renewal_count == 0" readonly="1"/>
                            <field name="renewal_parent_id" invisible="renewal_parent_id == False" readonly="1"/>
                            <field name="renewal_count" invisible="1"/>
                        </group>
                        <group id="protested">
                            <field name="protested_ids" widget="many2many_tags" string="Protestos" invisible="protested_count == 0" readonly="1"/>
                            <field name="protested_parent_id" invisible="protested_parent_id == False" readonly="1"/>
                            <field name="protested_count" invisible="1"/>
                        </group>
                    </group>
                    <notebook>
                        <page id="invoice_tab" name="invoice_tab" string="Facturas">
                            <field name="invoice_line_ids" readonly="state != 'draft'">
                                <tree editable="bottom">
                                    <field name="document_type_id"/>
                                    <field name="move_line_id" domain="[
                                        ('move_type', 'in', (move_invoice_type, 'entry')),
                                        ('l10n_latam_document_type_id', '=', document_type_id),
                                        ('partner_id', '=', partner_id),
                                        ('currency_id', '=', currency_id),
                                        ('parent_state', '=', 'posted'),
                                        ('amount_residual', '!=', 0),
                                        ('move_id.redeemed_state', '!=', 'redeemed'),
                                        ('move_id.payment_state', '!=', 'paid'),
                                        ('account_id.account_type', '=', account_type),
                                    ]"/>
                                    <field name="partner_id" optional="show"/>
                                    <field name="move_line_name"/>
                                    <field name="invoice_name" optional="hide"/>
                                    <field name="account_id"/>
                                    <field name="journal_id" optional="show"/>
                                    <field name="currency_id"/>
                                    <field name="amount_total_signed" sum="Total"/>
                                    <field name="letter_id" string="Nro. Canje" optional="hide" readonly="1"/>
                                    <field name="move_id" column_invisible="True"/>
                                    <field name="move_invoice_type" column_invisible="True"/>
                                    <field name="company_id" column_invisible="True"/>
                                    <field name="account_type" column_invisible="True"/>
                                    <button name="action_view_invoice" type="object" icon="fa-external-link"
                                        invisible="not move_line_id"/>
                                </tree>
                            </field>
                        </page>
                        <!-- Pestaña de letras -->
                        <page id="letter_tab" name="letter_lines" string="Letras">
                            <group>
                                <group id="header_left_group">
                                    <field name="number_letter"/>
                                    <field name="letter_end_date"/>
                                    <field name="range_date"/>
                                </group>
                                <group id="header_right_group">
                                    <field name="type_payment"/>
                                    <field name="partial_amount" invisible="type_payment != 'partial'"/>
                                    <field name="rest_amount"/>
                                    <field name="retention_percent"/>
                                    <field name="retention_amount" invisible="retention_percent == 0"/>
                                    <field name="total_amount_with_retention" invisible="retention_percent == 0"/>
                                </group>
                            </group>
                            <button name="create_letters" string="Crear Letras" type="object" class="oe_highlight"
                                invisible="state not in ('draft','checked')"/>
                            <field name="letter_line_ids" readonly="state in ('cancel','done')">
                                <tree name="letter_line_ids" editable="bottom" create="true" delete="false">
                                    <field name="sequence" widget="handle"/>
                                    <field name="is_selected" string="" style="width: 20px;" invisible="state in ('draft','checked','redeemed')"/>
                                    <field name="letter_user_id"/>
                                    <field name="nro_letter"/>
                                    <field name="bank_id" readonly="state in ('draft','checked')"/>
                                    <field name="code" readonly="state in ('draft','checked')"/>
                                    <field name="account_id"/>
                                    <field name="range_date"/>
                                    <field name="expiration_date"/>
                                    <field name="amount_total" sum="Importe total"/>
                                    <field name="payment_state" optional="show" widget="badge"
                                        decoration-info="payment_state == 'pending'"
                                        decoration-success="payment_state in ('paid','renewed')"/>
                                    <field name="payment_id" optional="hide"/>
                                    <field name="move_invoice_type" column_invisible="True"/>                   
                                    <field name="letter_id" optional="hide" readonly="1"/>
                                    <field name="letter_type" column_invisible="True"/>
                                    <field name="state" column_invisible="True"/>
                                    <field name="currency_id" column_invisible="True"/>
                                    <field name="commission" readonly="payment_state == 'paid'" sum="Comisión total"/>
                                    <button name="action_open_preview_payment" string="Pagar" class="oe_highlight" type="object"
                                        invisible="move_invoice_type == 'in_invoice' or not (payment_state in ['pending','protested'] and commission > 0)"/>
                                    <!-- Botón de pago para Proveedores -->
                                    <button name="action_open_preview_payment" string="Pagar" class="oe_highlight" type="object"
                                        invisible="move_invoice_type == 'out_invoice' or (payment_state in ['paid','protested'] or state != 'billing')"/>
                                    <!-- Botón de eliminar -->
                                    <button name="unlink" type="object" icon="fa-trash-o"
                                        invisible="state != 'draft'"/>
                                </tree>
                            </field>
                        </page>
                        <!-- Pestaña de los apuntes contables -->
                        <page id="move_line" name="move_line" string="Apuntes contables">
                            <field name="account_move_line_ids" readonly="1">
                                <tree editable="bottom">
                                    <field name="account_id"/>
                                    <field name="name"/>
                                    <field name="analytic_distribution" optional="hide"/>
                                    <field name="date"/>
                                    <field name="amount_currency"/>
                                    <field name="debit" sum="Débito total" string="Debe"/>
                                    <field name="credit" sum="Crédito total" string="Haber"/>
                                    <field name="currency_id" optional="hide"/>
                                    <field name="company_id" column_invisible="True"/>
                                    <field name="company_currency_id" column_invisible="True"/>
                                </tree>
                            </field>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>
    <!-- Accion de ventana Cliente-->
    <record model="ir.actions.act_window" id="account_letter_action_clientes">
        <field name="name">Canje de Letras</field>
        <field name="res_model">account.letter</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="ccount_letter_view_filter"/>
        <field name="domain">[('type', '=', 'out_invoice')]</field>
        <field name="context">{'default_type': 'out_invoice'}</field>
    </record>
    <!-- Accion de ventana Proveedores-->
    <record model="ir.actions.act_window" id="account_letter_action_proveedores">
        <field name="name">Canje de Letras</field>
        <field name="res_model">account.letter</field>
        <field name="view_mode">tree,form</field>
        <field name="search_view_id" ref="ccount_letter_view_filter"/>
        <field name="domain">[('type', '=', 'in_invoice')]</field>
        <field name="context">{'default_type': 'in_invoice'}</field>
    </record>
</odoo>